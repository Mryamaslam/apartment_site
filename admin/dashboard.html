<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>City Scape Faletti’s Service Apartments | Admin Dashboard</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            background-color: #f5f5f5;
        }
        .sidebar {
            height: 100vh;
            background-color: #343a40;
            color: white;
            position: fixed;
            width: 220px;
            padding-top: 20px;
        }
        .sidebar a {
            color: #ddd;
            padding: 12px 20px;
            display: block;
            text-decoration: none;
            font-size: 0.95rem;
        }
        .sidebar a:hover, .sidebar a.active {
            background-color: #8B0000;
            color: white;
        }
        .main-content {
            margin-left: 220px;
            padding: 20px;
        }
    </style>
</head>
<body>

    <!-- Sidebar (simplified) -->
    <div class="sidebar">
        <h4 class="text-center mb-4">Fallete’s Admin</h4>
        <a href="#" class="active"><i class="fas fa-tachometer-alt me-2"></i> Leads Dashboard</a>
        <a href="#" onclick="loadFormSubmissions(); return false;"><i class="fas fa-users me-2"></i> Leads</a>
        <a href="../index.html"><i class="fas fa-external-link-alt me-2"></i> View Site</a>
        <a href="#" class="text-warning mt-4" onclick="logoutAdmin(); return false;"><i class="fas fa-sign-out-alt me-2"></i> Logout</a>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <nav class="navbar navbar-light bg-light mb-4 shadow-sm">
            <div class="container-fluid">
                <span class="navbar-brand mb-0 h1">Leads Dashboard</span>
                <div class="d-flex">
                    <span class="me-3">Welcome, Admin</span>
                    <a href="#" class="text-danger" onclick="logoutAdmin(); return false;">Logout</a>
                </div>
            </div>
        </nav>

        <div class="row">
            <div class="col-lg-12">
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Recent Leads</h5>
                        <div>
                            <button class="btn btn-sm btn-success me-2" onclick="exportToExcel()">
                                <i class="fas fa-file-excel me-1"></i> Export to Excel
                            </button>
                            <button class="btn btn-sm btn-primary" onclick="loadFormSubmissions()">
                                <i class="fas fa-sync-alt me-1"></i> Refresh
                            </button>
                        </div>
                    </div>
                    <div class="table-responsive border-top">
                        <table class="table table-hover mb-0" id="leadsTable">
                            <thead>
                                <tr>
                                    <th>Date & Time</th>
                                    <th>Name</th>
                                    <th>Phone</th>
                                    <th>Email</th>
                                    <th>Apartment Type</th>
                                    <th>User Type</th>
                                    <th>Message</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="leadsTableBody">
                                <tr>
                                    <td colspan="8" class="text-center text-muted py-4">Loading submissions...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/form-handler.js"></script>
    <script>
        // Get base path for API calls (fallback if form-handler.js doesn't load)
        function getApiPath(endpoint) {
            const isAdmin = window.location.pathname.includes('/admin/');
            return isAdmin ? `../api/${endpoint}` : `api/${endpoint}`;
        }

        // Fallback function if form-handler.js doesn't load
        if (typeof window.getFormSubmissions === 'undefined') {
            window.getFormSubmissions = async function() {
                try {
                    const apiPath = getApiPath('get-submissions.php');
                    console.log('Fetching from:', apiPath);
                    
                    const response = await fetch(apiPath);
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('API Error:', response.status, errorText);
                        throw new Error(`Failed to fetch submissions: ${response.status}`);
                    }
                    
                    const submissions = await response.json();
                    console.log('Received submissions:', submissions);
                    return Array.isArray(submissions) ? submissions : [];
                } catch (error) {
                    console.error('Error fetching submissions:', error);
                    return [];
                }
            };
        }

        if (typeof window.deleteSubmission === 'undefined') {
            window.deleteSubmission = async function(id) {
                try {
                    const response = await fetch(getApiPath('delete-submission.php'), {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ id: id })
                    });
                    
                    const result = await response.json();
                    return result.success || false;
                } catch (error) {
                    console.error('Error deleting submission:', error);
                    return false;
                }
            };
        }

        if (typeof window.exportToExcel === 'undefined') {
            window.exportToExcel = async function() {
                const submissions = await window.getFormSubmissions();
                
                if (submissions.length === 0) {
                    alert('No form submissions to export.');
                    return;
                }
                
                // Create CSV content
                const headers = ['ID', 'Date & Time', 'Full Name', 'Phone Number', 'Email', 'Apartment Type', 'User Type', 'Message'];
                const csvRows = [headers.join(',')];
                
                submissions.forEach(sub => {
                    const row = [
                        sub.id,
                        `"${sub.date || ''}"`,
                        `"${sub.fullName || ''}"`,
                        `"${sub.phoneNumber || ''}"`,
                        `"${sub.email || ''}"`,
                        `"${sub.apartmentType || ''}"`,
                        `"${sub.userType || ''}"`,
                        `"${(sub.message || '').replace(/"/g, '""')}"`
                    ];
                    csvRows.push(row.join(','));
                });
                
                const csvContent = csvRows.join('\n');
                
                // Create blob and download
                const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                link.setAttribute('href', url);
                link.setAttribute('download', `form_submissions_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };
        }

        // Simple front-end protection: require login flag in localStorage
        document.addEventListener('DOMContentLoaded', function() {
            const isLoggedIn = localStorage.getItem('adminLoggedIn') === 'true';
            if (!isLoggedIn) {
                window.location.href = 'login.html';
                return;
            }
            loadFormSubmissions();
        });

        async function loadFormSubmissions() {
            const tbody = document.getElementById('leadsTableBody');

            // Show loading
            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-4">Loading submissions...</td></tr>';
            }

            try {
                const submissions = await window.getFormSubmissions();
                console.log('Submissions loaded:', submissions);

                // Clear existing rows
                if (tbody) {
                    tbody.innerHTML = '';

                    if (!submissions || submissions.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-4">No form submissions yet. Submit a form from the website to see data here.</td></tr>';
                        return;
                    }

                    // Display submissions (already sorted by server)
                    submissions.forEach(sub => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${sub.date || 'N/A'}</td>
                            <td>${sub.fullName || 'N/A'}</td>
                            <td><a href="tel:${sub.phoneNumber || ''}">${sub.phoneNumber || 'N/A'}</a></td>
                            <td>${sub.email ? `<a href="mailto:${sub.email}">${sub.email}</a>` : 'N/A'}</td>
                            <td>${sub.apartmentType || 'N/A'}</td>
                            <td>${sub.userType || 'N/A'}</td>
                            <td>${sub.message ? `<span title="${sub.message}">${sub.message.length > 30 ? sub.message.substring(0, 30) + '...' : sub.message}</span>` : 'N/A'}</td>
                            <td>
                                <button class="btn btn-sm btn-danger" onclick="deleteSubmissionHandler('${sub.id}')" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                }
            } catch (error) {
                if (tbody) {
                    tbody.innerHTML = `<tr><td colspan="8" class="text-center text-danger py-4">
                        Error loading submissions. <br>
                        <small>Check browser console (F12) for details.</small><br>
                        <button class="btn btn-sm btn-primary mt-2" onclick="loadFormSubmissions()">Try Again</button>
                    </td></tr>`;
                }
                console.error('Error loading submissions:', error);
            }
        }

        async function deleteSubmissionHandler(id) {
            if (confirm('Are you sure you want to delete this submission?')) {
                const success = await window.deleteSubmission(id);
                if (success) {
                    loadFormSubmissions(); // Reload the list
                } else {
                    alert('Error deleting submission. Please try again.');
                }
            }
        }

        function logoutAdmin() {
            localStorage.removeItem('adminLoggedIn');
            window.location.href = 'login.html';
        }

        // Make functions globally available
        window.loadFormSubmissions = loadFormSubmissions;
        window.deleteSubmissionHandler = deleteSubmissionHandler;
        window.logoutAdmin = logoutAdmin;
    </script>
</body>
</html>
